#!/usr/bin/env bash

set -euo pipefail

# shellcheck source=./../../modules/dotly/scripts/core/_main.sh
source "$DOTLY_PATH/scripts/core/_main.sh"


##? Changes db in config file
#?? 1.0.0
##?
##? Usage:
##?   change-db <dbName> [--regendb] [--styles]
docs::parse "$@"

ROOT_CONTENT=$(git rev-parse --show-toplevel)
FILE=$(find $ROOT_CONTENT -name "database.php" -not -path "*/testing/*")

if [ -f "$FILE" ]; then
    numFileDatabase="$(grep -En "^[\$]db\[[\"']default[\"']\]\[[\"']database[\"']\]" $FILE | head -n 1 | cut -d: -f1)"

    sed -i "${numFileDatabase}s/.*/\$db[\"default\"][\"database\"] = '$dbName';/" $FILE

    $regendb && echo "Ejecutando regenerate_db..." && curl -s "http://eventscase.loc/tools/regenerate_db"
    $styles && echo "Ejecutando less_compile..." && curl -s "http://eventscase.loc/tools/less_compile_all"

    echo ""
    echo "💾 Database changed correctly to $dbName"
else
    >&2 echo "🏚 Database config file not found. Make sure you are inside the project folder."
fi

